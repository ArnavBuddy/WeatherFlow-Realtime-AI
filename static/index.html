<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realtime AI Chat</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #chat { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        .message { margin-bottom: 10px; }
        .user { color: blue; font-weight: bold; }
        .ai { color: green; }
        #controls { display: flex; gap: 10px; }
        #messageInput { flex-grow: 1; }
    </style>
</head>
<body>
    <h1>Realtime AI Backend Demo</h1>
    <div id="status">Connecting...</div>
    <div id="chat"></div>
    <div id="controls">
        <input type="text" id="messageInput" placeholder="Type a message..." disabled>
        <button id="sendBtn" disabled>Send</button>
    </div>

    <script>
        // Generate a random session ID
        function uuidv4() {
             return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        const sessionId = uuidv4();
        console.log("Session ID:", sessionId);

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/session/${sessionId}`;
        
        const socket = new WebSocket(wsUrl);
        const chatDiv = document.getElementById('chat');
        const input = document.getElementById('messageInput');
        const btn = document.getElementById('sendBtn');
        const status = document.getElementById('status');

        let currentAiMessageDiv = null;

        socket.onopen = function(e) {
            status.textContent = "Connected (Session: " + sessionId + ")";
            input.disabled = false;
            btn.disabled = false;
        };

        socket.onmessage = function(event) {
            // Streamed content
            if (!currentAiMessageDiv) {
                currentAiMessageDiv = document.createElement('div');
                currentAiMessageDiv.className = 'message';
                const sender = document.createElement('span');
                sender.className = 'ai';
                sender.textContent = "AI: ";
                currentAiMessageDiv.appendChild(sender);
                const content = document.createElement('span');
                content.className = 'content';
                currentAiMessageDiv.appendChild(content);
                chatDiv.appendChild(currentAiMessageDiv);
            }
            
            const contentSpan = currentAiMessageDiv.querySelector('.content');
            contentSpan.textContent += event.data;
            chatDiv.scrollTop = chatDiv.scrollHeight;
        };

        socket.onclose = function(event) {
             status.textContent = "Disconnected";
             input.disabled = true;
             btn.disabled = true;
        };

        function sendMessage() {
            const text = input.value;
            if (!text) return;
            
            // Add user message to chat
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            msgDiv.innerHTML = '<span class="user">You: </span>' + text;
            chatDiv.appendChild(msgDiv);
            chatDiv.scrollTop = chatDiv.scrollHeight;

            // Reset AI message buffer for next response
            currentAiMessageDiv = null;

            socket.send(text);
            input.value = '';
        }

        btn.onclick = sendMessage;
        input.onkeypress = function(e) {
            if (e.key === 'Enter') sendMessage();
        };

    </script>
</body>
</html>
